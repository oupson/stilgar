<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
    <title>Document</title>
</head>

<body>
    <script type="module">
        import { h, Component, render } from 'https://esm.sh/preact';
        import htm from 'https://esm.sh/htm';


        const html = htm.bind(h);

        class App extends Component {
            state = { states: {} };

            constructor() {
                super();

                this.setState({ states: {} });

                const socket = new WebSocket('ws://localhost:3000/ws');
                socket.addEventListener('open', function (event) {
                    socket.send('Hello Server!');
                });

                socket.addEventListener('message', this.onSocketMessage.bind(this));

            }

            onSocketMessage(event) {
                const msg = JSON.parse(event.data);
                this.state.states[msg.mac] = msg;
                this.setState(this.state);
            }

            componentDidMount() {
                console.debug("componentDidMount");
            }

            componentWillUnmount() {
                console.debug("componentWillUnmount");
            }

            render(props, state) {
                return html`
                <article class="app">
                    <h1>App</h1>
                    <ul>
                    ${Object.values(state.states).map(msg => html`
                        <li key=${msg}>${msg.mac} : ${msg.temperature}</li>
                    `)}
                    </ul>
                </article>
                `;
            }
        }

        render(html`<${App} />`, document.body);
    </script>
</body>

</html>
